<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø´Ø¯ - Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #1c4587; --success: #10b981; --danger: #ef4444; --bg: #f4f7f9; --warning: #f59e0b; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 500px; margin: 20px auto; }
        header { text-align: center; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        input { padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; width: 100%; box-sizing: border-box; font-family: 'Cairo'; font-size: 16px; margin-bottom: 15px; text-align: center; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        
        #resultArea { display: none; margin-top: 10px; animation: fadeIn 0.5s ease; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .amount { font-weight: bold; color: var(--primary); }
        .remaining { font-size: 24px; color: var(--danger); font-weight: 700; }
        
        .progress-container { background: #eee; border-radius: 20px; height: 12px; margin: 15px 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: 0%; transition: width 1s ease-in-out; }
        .countdown-box { padding: 12px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 15px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 50px; font-size: 14px; font-weight: bold; margin-top: 10px; }
        .paid { background: #d1fae5; color: #065f46; }
        .debt { background: #fee2e2; color: #b91c1c; }
        .near { background: #fef3c7; color: #92400e; }
        
        .payment-list { margin-top: 20px; background: #f8fafc; padding: 15px; border-radius: 12px; }
        .p-item { font-size: 14px; display: flex; justify-content: space-between; margin-bottom: 8px; color: #64748b; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; display: none; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="text-align: center;">
        <p style="font-weight: bold; color: var(--primary);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...</p>
    </div>
</div>

<div class="container">
    <header>
        <h1 style="color: var(--primary); margin-bottom: 5px;">Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø§Ø´Ø¯</h1>
        <p style="color: #64748b;">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†</p>
    </header>

    <div class="card" id="loginCard">
        <p style="text-align: center; margin-bottom: 20px;">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙƒÙ…Ø§ Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙ„</p>
        <input type="text" id="custNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
        <button onclick="checkAccess()">Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ÙŠ</button>
        <p id="errorMsg" style="color: var(--danger); text-align: center; margin-top: 10px; display: none; font-size: 14px;">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø§Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø³Ø¬Ù„Ø§ØªÙ†Ø§</p>
    </div>

    <div id="resultArea">
        <div class="card">
            <h2 id="displayName" style="margin-top: 0; color: var(--primary); text-align: center;"></h2>
            
            <div id="countdownArea"></div>

            <div id="statusBadgeContainer" style="text-align: center;"></div>
            
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; color: var(--primary);">
                    <span>Ù†Ø³Ø¨Ø© ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
            </div>

            <div style="margin-top: 15px;">
                <div class="info-row"><span>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²:</span> <span id="displayModel" class="amount"></span></div>
                <div class="info-row"><span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ:</span> <span id="displayTotal" class="amount"></span></div>
                <div class="info-row" style="border:none;"><span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø°Ù…ØªÙƒ:</span></div>
                <div style="text-align: center;" id="displayRemaining" class="remaining"></div>
            </div>

            <div class="payment-list">
                <p style="margin-top: 0; font-weight: bold; color: #475569; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§ØªÙƒ:</p>
                <div id="displayPayments"></div>
            </div>
            
            <button onclick="location.href='index.html'" style="margin-top: 20px; background: #64748b;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBpt495yhuoTbjunCLIFCF_8c1NesxZHWs",
        authDomain: "shopweb-3466b.firebaseapp.com",
        databaseURL: "https://shopweb-3466b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "shopweb-3466b",
        storageBucket: "shopweb-3466b.firebasestorage.app",
        messagingSenderId: "41811528812",
        appId: "1:41811528812:web:618f240f8106f218a8dc49"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function formatNum(n) { return Number(n).toLocaleString() + " Ø¯.Ø¹"; }

    // ÙˆØ¸ÙŠÙØ© ØªØ¨Ù„ÙŠØº Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†
    function notifyAdmin(userName) {
        db.ref('lastVisit').set({
            name: userName,
            time: Date.now()
        });
    }

    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    function checkAutoLogin() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id');

        if (userId) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            db.ref('installments/' + userId).once('value', (snap) => {
                const user = snap.val();
                document.getElementById('loadingOverlay').style.display = 'none';
                if (user) {
                    notifyAdmin(user.name);
                    showData(user);
                } else {
                    alert("Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                }
            });
        }
    }

    function checkAccess() {
        const nameInput = document.getElementById('custNameInput').value.trim();
        const errorMsg = document.getElementById('errorMsg');
        if(!nameInput) return;

        db.ref('installments').once('value', (snap) => {
            const data = snap.val();
            let foundUser = null;
            for(let id in data) {
                if(data[id].name.trim() === nameInput) {
                    foundUser = data[id];
                    break;
                }
            }
            if(foundUser) {
                notifyAdmin(foundUser.name);
                showData(foundUser);
            } else {
                errorMsg.style.display = 'block';
            }
        });
    }

    function showData(user) {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('displayName').innerText = user.name;
        document.getElementById('displayModel').innerText = user.model || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        document.getElementById('displayTotal').innerText = formatNum(user.total);
        
        let paid = 0;
        const payList = document.getElementById('displayPayments');
        payList.innerHTML = '';
        if(user.payments) {
            user.payments.forEach(p => {
                paid += p.amount;
                payList.innerHTML += `<div class="p-item"><span>ØªÙ… Ø¯ÙØ¹: ${formatNum(p.amount)}</span><span>Ø¨ØªØ§Ø±ÙŠØ®: ${p.date.split('|')[0]}</span></div>`;
            });
        }

        const rem = Math.max(0, user.total - paid);
        document.getElementById('displayRemaining').innerText = formatNum(rem);
        
        const percent = Math.min(100, Math.round((paid / user.total) * 100));
        document.getElementById('progressBar').style.width = percent + "%";
        document.getElementById('percentText').innerText = percent + "%";

        const badge = document.getElementById('statusBadgeContainer');
        const countdown = document.getElementById('countdownArea');
        
        if(rem <= 0) {
            badge.innerHTML = '<span class="status-badge paid">âœ… ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>';
            countdown.innerHTML = '';
        } else {
            badge.innerHTML = '<span class="status-badge debt">âš ï¸ Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>';
            
            if(user.nextDueDate) {
                const diff = user.nextDueDate - Date.now();
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                
                if(days > 7) {
                    countdown.innerHTML = `<div class="countdown-box debt" style="background:#d1fae5; color:#065f46;">â³ Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ù…ÙˆØ¹Ø¯ Ù‚Ø³Ø·Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù…: ${days} ÙŠÙˆÙ…</div>`;
                } else if (days > 0) {
                    countdown.innerHTML = `<div class="countdown-box near" style="background:#fef3c7; color:#92400e;">âš ï¸ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø³Ø· Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹: Ø¨Ø§Ù‚ÙŠ ${days} ÙŠÙˆÙ…</div>`;
                } else {
                    countdown.innerHTML = `<div class="countdown-box debt" style="background:#fee2e2; color:#b91c1c;">ğŸš¨ Ù…ØªØ£Ø®Ø± Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ù€ ${Math.abs(days)} ÙŠÙˆÙ…!</div>`;
                }
            }
        }
    }

    // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = checkAutoLogin;
</script>
</body>
</html>
